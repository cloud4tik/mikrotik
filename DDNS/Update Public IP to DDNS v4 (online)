:local name ("DDNS Mikrotik")
:local getip "https://v4.ident.me"
:local publicip ("publicip")
:local tokenurl "https://raw.githubusercontent.com/cloud4tik/mikrotik/main/DDNS/Update%20Public%20IP%20to%20DDNS%20v3.0%20(token)"
:local tokendns ("tokendns")
:local currentip [/ip firewall filter get [find where comment=public] dst-address];

#get public ip
/tool fetch url="$getip/?publicip.txt" mode=https src-path="/" dst-path="/$publicip"
:delay 3s
:local newip [/file get [find where name=$publicip] contents]
:local lannewip [:len $newip]
:log info "new public ip $newip"

:log info "neip=$newip"

:if ($currentip != $newip) do={
:local user [sys scr get [find where name=$name] owner]
:log info "tidak sama"
:log info "user =$user"

:log error "Current ddns ip not seme as new ddns ip"
:log info "$currentip != $newip"
:log error "ddns ip need update.."
:log warning "ddns ip update now. Pelase wait a moment.."
:log error "Dont turn off your router.."

/ip firewall filter set [find where comment=public] dst-address=$newip
/ip firewall filter set [find where comment=public1] dst-address=$newip
/ip firewall raw set [find where comment=public] dst-address=$newip
/ip firewall raw set [find where comment=public1] dst-address=$newip
#/ip firewall nat set [find where comment=public] dst-address=$newip
#/ip firewall nat set [find where comment=public1] dst-address=$newip

:log info "update ip cloud"
#/ip cloud force-update
#:delay 2s
#:log info "...."
/tool fetch url="$tokenurl" mode=https src-path="/" dst-path="/$tokendns"
:delay 3s
:local tokendata [/file get "$tokendns" contents]
/sys scr add name="$tokendns" comment="$tokendns" source="$tokendata"
:delay 3s

:local fconfig [:parse [/system script get $tokendns source]]

:local cfg [$fconfig]
:put "cfg=$cfg"
:local url1 ($cfg->"url1")
:local url2 ($cfg->"url2")
:local token1 ($cfg->"$user-1")
:local token2 ($cfg->"$user-2")

/tool fetch url="$url1$token1" mode=https dst-path="$user-1 update ip"
:delay 4s
/file remove "$user-1 update ip"
:delay 1s
:log info "...."

/tool fetch url="$url2$token2" mode=https dst-path="$user-2 update ip"
:delay 4s
/file remove "$user-2 update ip"
:delay 1s
:log info "...."

:delay 2s
if ([/file find where name="$tokendns"] != "") do={/file remove "$tokendns"}
if ([/file find where name="$publicip"] != "") do={/file remove "$publicip"}
if ([/file find where name="$name"] != "") do={/file remove "$name"}
/sys scr rem "$file"

:delay 1s

:log warning "ddns ip has been updated"
:log warning "Finish.."

} else={

:delay 2s
/file remove "$file"
/sys scr rem "$file"

:delay 1s
:log warning "Current ddns ip seme as new ddns ip"
:log info "$currentip = $newip"
:log warning "ddns ip no need update.."
:log warning "Finish.."

}
